#!/usr/bin/env bash

spinner() {

case "${1}" in
  dots)
    local frames=('â ' 'â ‚' 'â „' 'â¡€' 'â¢€' 'â  ' 'â ' 'â ˆ')
    ;;
  lines)
    local frames=('-' "\\" '|' '/')
    ;;
  hbar)
    local frames=('â–' 'â–‚' 'â–ƒ' 'â–„' 'â–…' 'â–†' 'â–‡' 'â–ˆ' 'â–‡' 'â–†' 'â–…' 'â–„' 'â–ƒ' 'â–‚' 'â–')
    ;;
  vbar)
    local frames=('â–‰' 'â–Š' 'â–‹' 'â–Œ' 'â–' 'â–' 'â–' 'â–' 'â–' 'â–Œ' 'â–‹' 'â–Š' 'â–‰')
    ;;
  arrows)
    local frames=('â†' 'â†–' 'â†‘' 'â†—' 'â†’' 'â†˜' 'â†“' 'â†™')
    ;;
  cubes)
    local frames=('â––' 'â–˜' 'â–' 'â–—')
    ;;
  corners)
    local frames=('â”¤' 'â”˜' 'â”´' 'â””' 'â”œ' 'â”Œ' 'â”¬' 'â”')
    ;;
  halfs)
    local frames=('â—' 'â—“' 'â—‘' 'â—’')
    ;;
  digi)
    local frames=('â£¾' 'â£½' 'â£»' 'â¢¿' 'â¡¿' 'â£Ÿ' 'â£¯' 'â£·')
    ;;
  clock)
    local frames=( "ğŸ•›" "ğŸ•" "ğŸ•‘" "ğŸ•’" "ğŸ•“" "ğŸ•”" "ğŸ••" "ğŸ•–" "ğŸ•—" "ğŸ•˜" "ğŸ•™" "ğŸ•š" )
    ;;
  "--help")
    printf "Usage: COMMAND | pipe-spinner [MODE]\n" >&2
    printf "  MODE: dots | lines | hbar | vbar | arrows | cubes | corners | halfs | digi | clock\n" >&2
    exit 1
    ;;
  *)
    local frames=('-' "\\" '|' '/')
    ;;
esac


  local delay=0.1
  local i=0

  # Hide cursor (ignore errors if tput not available)
  tput civis 2>/dev/null || true

  # Background animation loop on stderr
  {
    while :; do
      printf '\r%s ' "${frames[i]}" >&2
      i=$(( (i + 1) % ${#frames[@]} ))
      sleep "$delay"
    done
  } &
  local spid=$!

  # Main job: forward stdin â†’ stdout
  cat
  local cat_rc=$?

  # Stop spinner
  kill "$spid" 2>/dev/null || true
  wait "$spid" 2>/dev/null || true

  # Clear spinner line and restore cursor
  printf '\r   \r' >&2
  tput cnorm 2>/dev/null || true

  return "$cat_rc"
}

spinner "$@"
