#!/bin/bash

# backup btrfs subvol to another btrfs filesystem
#
## Version 2.0 specs
# - user getopts()
# - separate params for snaphot, old snapshot, backup dir, renaming, date postfix

## Functions

help() {
	echo "Usage: $(basename $0) [-odh] SNAPSHOT BACKUP_DIR"
	echo -e "\t-h\tDisplay help"
	echo -e "\t-o\tOld snapshot"
	echo -e "\t-d\tAdd date suffix"
	echo -e "\t-t\tAdd datetime suffix"
	echo -e "\t-a\tRetry full backup automatically"
	echo -e "\t-r\tRemove old source snapshot"

	exit 0
}

error() {
	MSG=$1
	echo "${MSG}"
	exit 1
}

get_rand() {
	cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 4 | head -n 1 
}

do_pause() {
	SECS=$1
	[[ $SECS =~ ^-?[0-9]+$ ]] || error "do_pause(): non-integer param given"
	for ((i = 0 ; i <= $SECS ; i++)); do
		printf "."
		sleep 1
	done
}

do_backup_full() {
	if (( $# != 2 )); then
    		help
	fi
	SRC="$0"
	DST="$1"
	ionice -c 3 nice -10 btrfs send  "${SRC}" | ionice -c 3 nice -10 btrfs receive "${DST}" 
}

do_backup_inc() {
	if (( $# != 3 )); then
    		help
	fi
	SRC="$0"
	OLD="$1"
	DST="$2"
	ionice -c 3 nice -10 btrfs send -p "${OLD}" "${SRC}" | ionice -c 3 nice -10 btrfs receive "${DST}" 
}

get_date_sfx() {
	if (( $# != 1 )); then
                help
        fi
        DATE="$0"

	POSTFIX="d"
	if [ "$(date --date "$DATE" +%-u)" -eq 7 ]; then POSTFIX="w"; fi
	if [ "$(date --date "$DATE" +%-d)" -eq 1 ]; then POSTFIX="m"; fi
	if [ "$(date --date "$DATE" +%-j)" -eq 1 ]; then POSTFIX="y"; fi

	echo "${DATE}${POSTFIX}"
}



## Params
unset OLD
unset DO_HELP
unset AUTO_RETRY
unset REMOVE
unset SFX
ADD_DATE_SFX=0
ADD_TIME_SFX=0


if (( $# < 2 )); then
    help
fi

while getopts 'hadtrs:o:' option
do
    case "$option" in
    h)
         help
         ;;
    a)
	AUTO_RETRY=1
	;;
    d)
         ADD_DATE_SFX=1
         ;;
    t)
         ADD_DATE_SFX=1
         ADD_TIME_SFX=1
         ;;
    r)
	REMOVE=1
	;;
    s)
         SFX="${OPTARG}"
         ;;
   o)
         OLD="${OPTARG}"
         ;;
    *)
        echo "Invalid argument received."
        help
        ;;
    esac
done

shift $((OPTIND-1))
OTHERARGS=$@

if (( ${#OTHERARGS[@]} != 2 )); then
   echo "Invalid arguments given. SNAPSHOT and/or BACKUP_DIR missing"
   help
fi

#################

#OLD="old"
#NEW="current"

SRC="$1"
DST_DIR="$2"
BASENAME="$(basename ${SRC})"

#### Test parameters
[ -d "${SRC}" ] &&  { echo "Source: ${SRC}" } || {  error "Source subvolume not found: ${SRC}"}
## Test for -o $OLD exists
[ -z ${OLD+x} -o  -d "${OLD}" ] || { error  "Old source subvolume -o defined, but \"${OLD}\" not found" ;}
[ -d "${DST_DIR}" ] && { echo "Destination: ${DST_DIR}";} || { error "Destination directory ${DST_DIR} not found"; } 

sync

unset FAILED

## Of -o is set
if [ ! -z ${OLD+x} ]; then
	echo "Trying to make incremental snapshot... pausing for 3 secs"
	do_pause 3

	do_backup_inc "${SRC}" "${OLD}" "${DST_DIR}" &&  echo "Incremental backup successful" || FAILED="TRUE"

	[ ! -z {FAILED+x} ] && echo "Incremental backup failed"
fi

if [ -z ${OLD+x} ] || [ ! -z ${FAILED} -a ! -z ${AUTO_RETRY} ]; then
	unset FAILED
	echo "Trying to make full backup"
	do_pause 3
	do_backup_full "${SRC}" "${DST_DIR}" && echo "Full backup successful" || FAILED="TRUE"
fi

if [ -z ${FAILED} ]; then
	BACKUP_NEW="${DST_DIR}/${BASENAME}"
	if [ ! -z ${ADD_DATE_SFX}]; then
		[ -z ${SFX} ] && SFX="_"
		DATE=$(btrfs subvolume show "${BACKUP_NEW}" |grep "Creation time" | cut -f 4 | cut -d \  -f -1)
		SFX="${SFX}$(get_date_sfx ${DATE})"
	fi
	if [ ! -z ${ADD_TIME_SFX}]; then
		TIME=$(btrfs subvolume show "${BACKUP_NEW}" |grep "Creation time" | cut -f 4 | cut -d \  -f -2 | tr -d :)
		SFX="${SFX}$(TIME}"
	fi

	if [ ! -z ${SFX} ]; then
		echo "Renaming snapshot"
		BACKUP_TARGET="${BACKUP_NEW}${SFX}"
		if [ -d "${BACKUP_TARGET}" ]; then
		        echo "Old snapshot exists: ${BACKUP_TARGET}. Adding prefix..."
		        BACKUP_TARGET="${BACKUP_TARGET}_$(get_rand)"
		fi
		mv -v "${BACKUP_NEW}" "${BACKUP_TARGET}" || error "Renaming new subvolume failed ${BACKUP_NEW}"
	fi
else
	error "btrfs backup FAILED"
fi

#### END

